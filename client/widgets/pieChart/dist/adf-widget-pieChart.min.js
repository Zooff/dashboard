!function(e,t){"use strict";function o(e){e.widget("pieChart",{title:"Camembert",description:"Widget permettant l'affichage de Camembert",templateUrl:"{widgetsPath}/pieChart/src/view/view.html",controller:"pieChartController",controllerAs:"graph",reload:!0,resolve:{data:["pieChartService","config",function(e,t){return e.get(t)}]},edit:{controller:"pieChartEditController",controllerAs:"graph",templateUrl:"{widgetsPath}/pieChart/src/edit/edit.html"}})}function i(t,o,i,a,l,n){if(o){var r=this;if(this.config=o.config,this.label=o.label,this.series=o.series,this.config.colorLabel=[],this.value=o.value,this.type=o.type,this.desc=o.desc,this.id=Math.random().toString(36).substr(2,10),console.log(this.id),this.series.forEach(function(e){r.config.colorLabel.push(e.name)}),r.options={chart:{type:"pie",backgroundColor:"transparent",height:"100%"},tooltip:{pointFormat:"{point.name}: <i>{point.y}</i> - <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{size:"100%",slicedOffset:5,borderWidth:3,allowPointSelect:!0,depth:45,dataLabels:{enabled:!1}},series:{borderColor:"transparent",borderWidth:5,states:{hover:{halo:!1}}}},series:[{type:"pie",data:r.series}],title:{text:null},legend:{floating:!1,verticalAlign:"bottom",align:"center",itemStyle:{color:"#337AB7"}},credits:{enabled:!1}},"doughnut"==this.type&&(this.options.plotOptions.pie.innerSize="75%"),this.config.legend&&(this.options.plotOptions.pie.showInLegend={enabled:!0}),this.config.v3d&&(r.options.chart.options3d={enabled:!0,alpha:45,beta:0}),r.config.color){r.color=[];for(var c in r.config.color)r.color[c]=r.config.color[c];r.options.plotOptions.pie.colors=r.color}(r.config.pourcent||r.config.pieValue)&&(r.options.plotOptions.pie.dataLabels={enabled:!0,distance:-20,formatter:function(){var e="";return 0!=this.percentage&&(r.config.pourcent&&(e+=this.percentage.toFixed(1)+"%"),r.config.pieValue&&(e+=" "+this.y)),e}}),o.config.listener&&a.$on("DatTest",function(e,t){r.config.expertReplace=t,r.config.urlReplace=t[r.config.slaveValue],r.load=!0,i.get(r.config).then(function(e){r.load=!1,r.label=e.label,r.value=e.value,r.chart.series[0].setData(e.series)})}),r["export"]=function(t){console.log("ok");var o=r.chart.getSVG({exporting:{sourceWidth:r.chart.chartWidth,sourceHeight:r.chart.chartHeight}}),i=document.createElement("canvas");i.height=1e3*r.chart.chartHeight/r.chart.chartWidth,i.width=1e3,document.body.appendChild(i);var a=new Image;a.onload=function(){i.getContext("2d").drawImage(this,0,0,1e3,1e3*r.chart.chartHeight/r.chart.chartWidth)},a.src="data:image/svg+xml;base64,"+e.btoa(o);t.currentTarget;if(i.msToBlob){var l=i.msToBlob();e.navigator.msSaveBlob(l,"graph.png")}else{var a=i.toDataURL("image/png");t.currentTarget.href=a,t.currentTarget.download="graph.png"}},this.open=function(e){var t=angular.copy(r.config);t.condition.group.rules.push({condition:"=",field:r.config.columnStandard,data:e});l.open({templateUrl:"{widgetsPath}/pieChart/src/view/modal.html",controller:"modalInstanceCtrl",controllerAs:"cm",size:"lg",windowClass:"my-modal",resolve:{data:["modalServicePC",function(e){return e.fetch(t)}]}})},"std"==r.config.mode&&(r.options.plotOptions.pie.point={cursor:"pointer",events:{click:function(e){r.open(this.name)}}}),angular.element(document).ready(function(){r.chart=Highcharts.chart(r.id,r.options)})}}function a(e,t,o){function i(e,t){var i=[];return angular.forEach(e.columns,function(e,a){if(e.title&&e.path){var l=e.title.replace(/_/," ");l=l.replace(/^bool/,""),t.headers[a]=e.title,i.push({title:e.title,path:o(e.path)})}}),i}function a(e,t){var a={headers:[],rows:[]};if(!e.columns){e.columns=[];for(var l in t[0])e.columns.push({title:l,path:l})}var n=t;e.rootData&&(n=o(e.rootData)(t));var r=i(e,a);return angular.forEach(n,function(e){var t=[];angular.forEach(r,function(o,i){var a=o.path(e);t[i]=a}),a.rows.push(t)}),a.totalItems=a.rows.length,a.columns=e.columns,e.condition.group.rules.pop(),a}function l(e){return t.post("/standard",e).then(function(e){return e.data}).then(function(t){return a(e,t)})}return{fetch:l}}function l(e){var t=this;this.data=e,this.sortIndex=function(e){return t.reverseSort=!t.reverseSort,t.orderField=e},this.sorter=function(e){return e[t.orderField]}}function n(e,t,o,i){function a(e){l.config.principalCol=[],l.config.otherCol=[],e.forEach(function(e){"principal"==e.type?l.config.principalCol.push(e):l.config.otherCol.push(e)})}var l=this;this.config=o,o.datasource={},l.config.principalCol||(l.config.principalCol=[]),l.config.otherCol||(l.config.otherCol=[]),o.condition||(o.condition={group:{operator:"AND",rules:[]}}),o.condition2||(o.condition2={group:{operator:"AND",rules:[]}}),this.getDatabase=function(){return t.get("/standard").then(function(e){return e.data})},this.getColumns=function(e){return t.get("/standard/columns",{params:{val:e}}).then(function(e){return e.data}).then(function(e){a(e),l.column=e})}}function r(e,t,o){function i(e,t){var i,a;t.key=[];for(var l in e[0])t.key.push(l);return t.label||(t.label=t.key[0]),t.value||(t.value=t.key[1]),i=o(t.label),a=o(t.value),d=e.map(function(e){return{name:i(e),y:a(e),sliced:t.sliced}}),{config:t,type:t.type,desc:t.desc,series:d}}function a(e){var o=e.url.replace(/:\w*/,e.urlReplace);return t.get(o).then(function(e){return e.data}).then(function(t){return i(t,e)})}function l(e){var t=null;return"exp"==e.mode?t=n(e,r):"std"==e.mode?t=n(e,c):"easy"==e.mode&&(e.datasource.selected&&(e.url=e.datasource.selected.url),t=a(e)),t}function n(e,o){return t.post(o,e).then(function(e){return e.data}).then(function(t){return i(t,e)})}var r="/expert/query",c="/standard/graph",d=[];return{get:l}}angular.module("adf.widget.pieChart",["adf.provider"]).config(o),o.$inject=["dashboardProvider"],angular.module("adf.widget.pieChart").run(["$templateCache",function(e){e.put("{widgetsPath}/pieChart/src/edit/edit.html",'<script type=text/ng-template id=autocomplete.html><a> <span ng-bind-html="match.model.url | uibTypeaheadHighlight:query"></span> | <small ng-bind-html="match.model.desc | uibTypeaheadHighlight:query"></small> </a></script><form role=form><div><label>Description</label></div><div class=form-group><label class=sr-only for=desc>Description</label> <input type=text id=desc class=form-control ng-model=config.desc placeholder=Description></div><hr><input type=radio ng-model=config.mode value=easy id=easy> <label for=easy>Mode Facile</label> <input type=radio ng-model=config.mode value=std id=std> <label for=std>Mode Standard</label> <input type=radio ng-model=config.mode value=exp id=exp> <label for=exp>Mode Expert</label><div class=form-group ng-if="config.mode == \'easy\'"><easy-mode config=config><easy-mode></easy-mode></easy-mode></div><div class=form-group ng-if="config.mode == \'std\'"><div class=form-group><label for=sample>Datasources</label> <input id=sample type=text class=form-control ng-model=config.databaseStandard placeholder="Type du Check" autocomplete=off uib-typeahead="database for database in graph.getDatabase($viewValue)" typeahead-min-length=0 typeahead-on-select=graph.getColumns(config.databaseStandard)></div><div class=form-group><label for=sample>Label</label> <input id=sample type=text class=form-control ng-model=config.columnStandard autocomplete=off uib-typeahead="col as col.name for col in graph.column" typeahead-min-length=0></div><div class=form-group><label for=standardTest>Condition :</label></div><p ng-hide=config.principalCol.length>Choissisez une datasource !</p><div ng-if=config.principalCol.length><label><small>Choix de la Référence</small></label><query-builder group=config.condition.group fields=config.principalCol database=config.databaseStandard></query-builder></div><div ng-if="config.condition.group.rules[0] && config.condition.group.rules[0].data"><label><small>Choix des caractéristique secondaires</small></label><query-builder group=config.condition2.group fields=config.otherCol database=config.databaseStandard></query-builder></div><showsql type=pie config=config></showsql></div><div ng-if="config.mode == \'exp\'"><expert-mode config=config></expert-mode></div><hr><div><label>Configuration du Graph</label></div><input ng-if="config.mode == \'easy\' || \'expert\'" id=listener type=checkbox ng-model=config.listener> <label ng-if="config.mode == \'easy\' || \'expert\'" for=listener>Slave</label><div ng-if=config.listener><label>Master Column</label> <input type=text ng-model=config.slaveValue></div><div><label>Type de Graph</label></div><div class=form-group><label class=sr-only for=sample>Chart Type</label><select class=form-control ng-model=config.type><option value=pie>Camenbert</option><option value=polarArea>PolarArea</option><option value=doughnut>Doughnut</option></select></div><div><label>Label (Configuration Automatique)</label></div><div class=form-group><label class=sr-only for=label>Label</label> <input type=text id=label class=form-control ng-model=config.label placeholder=Label uib-typeahead="key for key in config.key" typeahead-min-length=0 autocomplete=off></div><div><label>Value (Configuration Automatique)</label></div><div class=form-group><label class=sr-only for=value>Value</label> <input type=text id=value class=form-control ng-model=config.value placeholder=Données uib-typeahead="key for key in config.key" typeahead-min-length=0 autocomplete=off></div><div><label ng-click="isCollapsed = !isCollapsed">Chart Option <span ng-hide=isCollapsed class="glyphicon glyphicon-triangle-bottom" aria-hidden=true></span> <span ng-show=isCollapsed class="glyphicon glyphicon-triangle-top" aria-hidden=true></span></label></div><div ng-show=isCollapsed><div><input type=checkbox ng-model=config.legend id=legend> <label for=legend>Legende</label></div><div><input type=checkbox ng-model=config.pourcent id=pouc> <label for=pouc>Afficher les pourcentages sur le Graph</label></div><div><input type=checkbox ng-model=config.pieValue id=pieValue> <label for=pieValue>Afficher la valeur sur le Graph</label></div><div><input type=checkbox ng-model=config.sliced id=sliced> <label for=sliced>Sliced Graph</label></div><div><input type=checkbox ng-model=config.v3d id=v3d> <label for=v3d>3D</label></div><label>Choix des Couleurs</label><div ng-repeat="l in config.colorLabel" ng-if="config.colorLabel && $index % 2 == 0" class=row><div class=col-md-6><label for=color>{{l}} :</label><color-picker ng-model=config.color[$index] options="{required : false, format : \'hexString\'}"></color-picker></div><div class=col-md-6 ng-if="config.colorLabel.length > $index +1"><label for=color>{{config.colorLabel[$index +1]}} :</label><color-picker ng-model=config.color[$index+1] options="{required : false, format : \'hexString\'}"></color-picker></div></div></div></form>'),e.put("{widgetsPath}/pieChart/src/view/modal.html","<modal-table data=cm.data></modal-table>"),e.put("{widgetsPath}/pieChart/src/view/view.html",'<div><div ng-hide=graph.series class="alert alert-info" role=alert>Please insert a url to the widget configuration</div><div ng-show=graph.series><div><div id={{graph.id}} ng-class="{click : graph.config.mode == \'std\'}"></div></div><div><p class=text-center>{{graph.desc}}</p></div><a ng-click=graph.export($event)><button type=button class="btn btn-info"><i class="fa fa-file-excel-o" aria-hidden=true></i></button></a> <button type=button class="btn btn-success" ng-csv=graph.series field-separator=; filename="{{$parent.model.title + \'.csv\'}}"><i class="fa fa-file-excel-o" aria-hidden=true></i></button></div></div>')}]),angular.module("adf.widget.pieChart").controller("pieChartController",i),i.$inject=["$scope","data","pieChartService","$rootScope","$uibModal","$timeout"],angular.module("adf.widget.pieChart").service("modalServicePC",a),a.$inject=["$q","$http","$parse"],angular.module("adf.widget.pieChart").controller("modalInstanceCtrl",l),l.$inject=["data"],angular.module("adf.widget.pieChart").controller("pieChartEditController",n),n.$inject=["$scope","$http","config","pieChartService"],angular.module("adf.widget.pieChart").service("pieChartService",r),r.$inject=["$q","$http","$parse"]}(window);