!function(e,a){"use strict";function t(e){e.widget("pieChart",{title:"Camembert",description:"Widget permettant l'affichage de Camembert",templateUrl:"{widgetsPath}/pieChart/src/view/view.html",controller:"pieChartController",controllerAs:"graph",reload:!0,resolve:{data:["pieChartService","config",function(e,a){return e.get(a)}]},edit:{controller:"pieChartEditController",controllerAs:"graph",templateUrl:"{widgetsPath}/pieChart/src/edit/edit.html"}})}function o(a,t,o,l,i){if(t){var n=this;if(this.config=t.config,this.label=t.label,this.config.colorLabel=this.label,this.value=t.value,this.type=t.type,this.desc=t.desc,n.config.color){n.color=[];for(var r in n.config.color)n.color[r]=n.config.color[r]}var c;c="doughnut"==this.type?75:0,this.options={elements:{arc:{borderWidth:1,borderColor:"#222222"}},cutoutPercentage:c},this.config.legend&&(this.options.legend={display:!0,position:this.config.legendPosition}),"polarArea"!=this.config.type&&(this.config.pourcent||this.config.pieValue)&&(n.options.animation={},n.options.animation.onComplete=function(){var e=this.chart.ctx;e.font=Chart.helpers.fontString(20,"normal",Chart.defaults.global.defaultFontFamily),e.textAlign="center",e.textBaseline="bottom",this.data.datasets.forEach(function(a){for(var t=0;t<a.data.length;t++){var o=a._meta[Object.keys(a._meta)[0]].data[t]._model,l=a._meta[Object.keys(a._meta)[0]].total,i=o.innerRadius+(o.outerRadius-o.innerRadius)/2,r=o.startAngle,c=o.endAngle,d=r+(c-r)/2,s=i*Math.cos(d),p=i*Math.sin(d);e.fillStyle="#fff";var u=a.data[t],g=String(Math.round(u/l*100)+"%");o.circumference>0&&0!=u&&(n.config.pieValue&&e.fillText(a.data[t],o.x+s,o.y+p-5),n.config.pourcent&&e.fillText(g,o.x+s,o.y+p+15))}})}),t.config.listener&&l.$on("DatTest",function(e,a){n.config.urlReplace=a[n.config.slaveValue],n.load=!0,o.get(n.config).then(function(e){n.load=!1,n.label=e.label,n.value=e.value})}),a.$on("chart-create",function(e,a){n.chart=a}),this["export"]=function(a){if(n.chart.chart.canvas.msToBlob){var t=n.chart.chart.canvas.msToBlob();e.navigator.msSaveBlob(t,"graph.png")}else{var o=n.chart.toBase64Image();o=o.replace("image/png","image/octet-stream"),a.currentTarget.href=o,a.currentTarget.download="graph.png"}},this.open=function(e,a){if("std"==n.config.mode){var t=angular.copy(n.config);t.condition.group.rules.push({condition:"=",field:n.config.columnStandard,data:e[0]._model.label});i.open({templateUrl:"{widgetsPath}/pieChart/src/view/modal.html",controller:"modalInstanceCtrl",controllerAs:"cm",size:"lg",windowClass:"my-modal",resolve:{data:["modalServicePC",function(e){return e.fetch(t)}]}})}}}}function l(e,a,t){function o(e,a){var o=[];return angular.forEach(e.columns,function(e,l){if(e.title&&e.path){var i=e.title.replace(/_/," ");i=i.replace(/^bool/,""),a.headers[l]=e.title,o.push({title:e.title,path:t(e.path)})}}),o}function l(e,a){var l={headers:[],rows:[]};if(!e.columns){e.columns=[];for(var i in a[0])e.columns.push({title:i,path:i})}var n=a;e.rootData&&(n=t(e.rootData)(a));var r=o(e,l);return angular.forEach(n,function(e){var a=[];angular.forEach(r,function(t,o){var l=t.path(e);a[o]=l}),l.rows.push(a)}),l.totalItems=l.rows.length,l.columns=e.columns,e.condition.group.rules.pop(),l}function i(e){return a.post("/standard",e).then(function(e){return e.data}).then(function(a){return l(e,a)})}return{fetch:i}}function i(e){var a=this;this.data=e,this.sortIndex=function(e){return a.reverseSort=!a.reverseSort,a.orderField=e},this.sorter=function(e){return e[a.orderField]}}function n(e,a,t,o){function l(e){i.config.principalCol=[],i.config.otherCol=[],e.forEach(function(e){"principal"==e.type?i.config.principalCol.push(e):i.config.otherCol.push(e)})}var i=this;this.config=t,t.datasource={},i.config.principalCol||(i.config.principalCol=[]),i.config.otherCol||(i.config.otherCol=[]),t.condition||(t.condition={group:{operator:"AND",rules:[]}}),t.condition2||(t.condition2={group:{operator:"AND",rules:[]}}),this.getDatabase=function(){return a.get("/standard").then(function(e){return e.data})},this.getColumns=function(e){return a.get("/standard/columns",{params:{val:e}}).then(function(e){return e.data}).then(function(e){l(e),i.column=e})}}function r(e,a,t){function o(e,a){var o,l;a.key=[];for(var i in e[0])a.key.push(i);return a.label||(a.label=a.key[0]),a.value||(a.value=a.key[1]),o=t(a.label),l=t(a.value),d=e.map(function(e){return o(e)}),s=e.map(function(e){return l(e)}),{config:a,label:d,value:s,type:a.type,desc:a.desc}}function l(e){var t=e.url.replace(/:\w*/,e.urlReplace);return a.get(t).then(function(e){return e.data}).then(function(a){return o(a,e)})}function i(e){var a=null;return"exp"==e.mode?a=n(e,r):"std"==e.mode?a=n(e,c):"easy"==e.mode&&(e.datasource.selected&&(e.url=e.datasource.selected.url),a=l(e)),a}function n(e,t){return a.post(t,e).then(function(e){return e.data}).then(function(a){return o(a,e)})}var r="/expert/query",c="/standard/graph",d=[],s=[];return{get:i}}angular.module("adf.widget.pieChart",["adf.provider"]).config(t),t.$inject=["dashboardProvider"],angular.module("adf.widget.pieChart").run(["$templateCache",function(e){e.put("{widgetsPath}/pieChart/src/edit/edit.html",'<script type=text/ng-template id=autocomplete.html><a> <span ng-bind-html="match.model.url | uibTypeaheadHighlight:query"></span> | <small ng-bind-html="match.model.desc | uibTypeaheadHighlight:query"></small> </a></script><form role=form><div><label>Description</label></div><div class=form-group><label class=sr-only for=desc>Description</label> <input type=text id=desc class=form-control ng-model=config.desc placeholder=Description></div><hr><input type=radio ng-model=config.mode value=easy id=easy> <label for=easy>Mode Facile</label> <input type=radio ng-model=config.mode value=std id=std> <label for=std>Mode Standard</label> <input type=radio ng-model=config.mode value=exp id=exp> <label for=exp>Mode Expert</label><div class=form-group ng-if="config.mode == \'easy\'"><easy-mode config=config><easy-mode></easy-mode></easy-mode></div><div class=form-group ng-if="config.mode == \'std\'"><div class=form-group><label for=sample>Datasources</label> <input id=sample type=text class=form-control ng-model=config.databaseStandard placeholder="Type du Check" autocomplete=off uib-typeahead="database for database in graph.getDatabase($viewValue)" typeahead-min-length=0 typeahead-on-select=graph.getColumns(config.databaseStandard)></div><div class=form-group><label for=sample>Label</label> <input id=sample type=text class=form-control ng-model=config.columnStandard autocomplete=off uib-typeahead="col as col.name for col in graph.column" typeahead-min-length=0></div><div class=form-group><label for=standardTest>Condition :</label></div><p ng-hide=config.principalCol.length>Choissisez une datasource !</p><div ng-if=config.principalCol.length><label><small>Choix de la Référence</small></label><query-builder group=config.condition.group fields=config.principalCol database=config.databaseStandard></query-builder></div><div ng-if="config.condition.group.rules[0] && config.condition.group.rules[0].data"><label><small>SEC</small></label><query-builder group=config.condition2.group fields=config.otherCol database=config.databaseStandard></query-builder></div></div><div ng-if="config.mode == \'exp\'"><expert-mode config=config></expert-mode></div><hr><div><label>Configuration du Graph</label></div><input ng-if="config.mode == \'easy\' || \'expert\'" id=listener type=checkbox ng-model=config.listener> <label ng-if="config.mode == \'easy\' || \'expert\'" for=listener>Slave</label><div ng-if=config.listener><label>Master Column</label> <input type=text ng-model=config.slaveValue></div><div><label>Type de Graph</label></div><div class=form-group><label class=sr-only for=sample>Chart Type</label><select class=form-control ng-model=config.type><option value=pie>Camenbert</option><option value=polarArea>PolarArea</option><option value=doughnut>Doughnut</option></select></div><div><label>Label (Configuration Automatique)</label></div><div class=form-group><label class=sr-only for=label>Label</label> <input type=text id=label class=form-control ng-model=config.label placeholder=Label uib-typeahead="key for key in config.key" typeahead-min-length=0 autocomplete=off></div><div><label>Value (Configuration Automatique)</label></div><div class=form-group><label class=sr-only for=value>Value</label> <input type=text id=value class=form-control ng-model=config.value placeholder=Données uib-typeahead="key for key in config.key" typeahead-min-length=0 autocomplete=off></div><div><label ng-click="isCollapsed = !isCollapsed">Chart Option <span ng-hide=isCollapsed class="glyphicon glyphicon-triangle-bottom" aria-hidden=true></span> <span ng-show=isCollapsed class="glyphicon glyphicon-triangle-top" aria-hidden=true></span></label></div><div ng-show=isCollapsed><div><input type=checkbox ng-model=config.legend id=legend> <label for=legend>Legende</label></div><div><label>Position de la Legende</label></div><select ng-model=config.legendPosition><option value=top selected>Haut</option><option value=bottom>Bas</option><option value=left>Gauche</option><option value=right>Droite</option></select><div><input type=checkbox ng-model=config.pourcent id=pouc> <label for=pouc>Afficher les pourcentages sur le Graph</label></div><div><input type=checkbox ng-model=config.pieValue id=pieValue> <label for=pieValue>Afficher la valeur sur le Graph</label></div><label>Choix des Couleurs</label><div ng-if=config.colorLabel ng-repeat="l in config.colorLabel"><label>{{l}}</label> <input type=color ng-model=config.color[$index]></div></div></form>'),e.put("{widgetsPath}/pieChart/src/view/modal.html","<modal-table data=cm.data></modal-table>"),e.put("{widgetsPath}/pieChart/src/view/view.html",'<div><div ng-hide=graph.label class="alert alert-info" role=alert>Please insert a url to the widget configuration</div><div ng-show=graph.label><div><canvas id=graph class=chart-base ng-class="{click : graph.config.mode == \'std\'}" chart-type=graph.type chart-data=graph.value chart-labels=graph.label chart-colors=graph.color chart-options=graph.options chart-click=graph.open></canvas></div><div><p class=text-center>{{graph.desc}}</p></div><my-export chart=graph.chart></my-export></div></div>')}]),angular.module("adf.widget.pieChart").controller("pieChartController",o),o.$inject=["$scope","data","pieChartService","$rootScope","$uibModal"],angular.module("adf.widget.pieChart").service("modalServicePC",l),l.$inject=["$q","$http","$parse"],angular.module("adf.widget.pieChart").controller("modalInstanceCtrl",i),i.$inject=["data"],angular.module("adf.widget.pieChart").controller("pieChartEditController",n),n.$inject=["$scope","$http","config","pieChartService"],angular.module("adf.widget.pieChart").service("pieChartService",r),r.$inject=["$q","$http","$parse"]}(window);